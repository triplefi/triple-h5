function getMS(interval){var ms=0;if(!isNaN(interval)){ms=mtoms(interval)}if(interval.indexOf('D')>-1){var d=parseInt(interval)?parseInt(interval):1;ms=mtoms(d*24*60)}if(interval.indexOf('W')>-1){var w=parseInt(interval)?parseInt(interval):1;ms=mtoms(w*7*24*60)}if(interval.indexOf('M')>-1){var m=parseInt(interval)?parseInt(interval):1;ms=mtoms(m*30*7*24*60)}function mtoms(m){return m*60*1000}return ms}function Dep(){this.handles={}}Dep.prototype={constructor:Dep,sub:function(handle,callback){if(typeof handle!=='string'){throw new Error('handle must be a string!')}if(!this.handles[handle]){this.handles[handle]=[]}this.handles[handle].push(callback)},unSub:function(handle){var that=this;if(this.handles[handle]){this.handles[handle].forEach(function(item,index){that.handles[handle][index]=null});this.handles[handle]=null}},pub:function(){if(!arguments[0]||typeof arguments[0]!=='string'){throw new Error('the first param must be a string!')}var handles=this.handles[arguments[0]];if(handles&&handles.length>0){var arg=Array.prototype.slice.call(arguments,1);handles.forEach(function(handleItem){if(typeof handleItem==='function'){handleItem.apply(null,arg)}})}}};function sumStrings(a){a=a.toString();var indexOfE=a.indexOf('E');if(indexOfE<0){indexOfE=a.indexOf('e')}if(indexOfE===-1){return a}var indexOfFloat=a.indexOf('.');var zs=a.substr(0,indexOfE);var xs=a.substring(indexOfE+1);xs=Number(xs);if(xs<0){xs=Math.abs(xs)}var float='';while(xs--){float+='0'}if(indexOfFloat<0){float=float.substring(1);zs='0.'+float+zs;return zs}zs=zs.replace('.','.'+float);return zs}function duplicateRemoval(arr,field,callback){var hash={};arr=arr.reduce(function(item,next){hash[next[field]]?'':hash[next[field]]=true&&item.push(next);return item},[]);if(callback){arr=callback(arr)}return arr}function formatBarData(data,resolution){if(!data){return[]}if(typeof data==='string'){data=JSON.parse(data)}if(data.constructor!==Array){throw new Error('data must be an array!')}var ret=[];var tempObj={};data=duplicateRemoval(data,'time');data.forEach(function(item){tempObj={time:item.time,close:item.close,open:item.open,high:item.high,low:item.low,volume:item.vol,isBarClosed:true,isLastBar:false};ret.push(tempObj)});return ret}function UDFCompatibleDatafeed(dataSource,vue,config,businessData){this.DataProvider=dataSource;this._config=config;this._businessConf=businessData;this._vue=vue;this._dep=new Dep();this.isTooNear=false;this.preData=[];this.isWSOpen=false;this.subscriberID=null;this.getBarsTimer=null;this.onResetCacheNeededCallback=function(){}}UDFCompatibleDatafeed.prototype={constructor:UDFCompatibleDatafeed,onReady:function(callback){if(typeof this._config!=='object'){throw new Error('UDFCompatibleDatafeed config need an object!!')}var that=this;setTimeout(function(){callback(that._config)},0);that._ws=new that.DataProvider({url:that._businessConf.wsURL});that._ws.opt.onMsgCall=function(data){var sourceData=formatBarData(data.data,that._businessConf.interval);var prevLen=that.preData.length;var curLen=sourceData.length;that._vue.$emit('chartReady');if(prevLen>0&&!data.success&&curLen===1&&that.preData[prevLen-1].time>sourceData[0].time){return false}that.preData=JSON.parse(JSON.stringify(sourceData));if(sourceData.length>=0&&data.success){that._dep.pub('firstData',sourceData);return}else if(curLen===1){sourceData[0].isBarClosed=true;sourceData[0].isLastBar=false;that._dep.pub('newData',sourceData)}};that._ws.opt.onOpenCall=function(){that.isWSOpen=true;};return false},searchSymbols:function(userInput,exchange,symbolType,onResultReadyCallback){onResultReadyCallback([])},resolveSymbol:function(symbolName,onSymbolResolvedCallback,onResolveErrorCallback){var that=this;setTimeout(function(){onSymbolResolvedCallback(that._businessConf.symbolResolveConf)},0);return false},getBars:function(symbolInfo,resolution,from,to,onHistoryCallback,onErrorCallback,firstDataRequest){var that=this;function gogo(){if(!firstDataRequest){onHistoryCallback([],{noData:true});return true}if(that.isWSOpen){that._dep.sub('firstData',function(data){var cbParams=null;onHistoryCallback(data);that._dep.unSub('firstData')});that._ws.sendMsg('[{"type":"subHq_cancel_all","event":"kline"}]');setTimeout(function(){that._ws.sendMsg(JSON.stringify([{type:'subHq',event:'kline',param:{businessType:that._businessConf.symbolResolveConf.description,kType:that._businessConf.chart.resolutionsToKtype[resolution],size:that._businessConf.wsMsg.size}}]))},0);clearTimeout(that.getBarsTimer)}else{that.getBarsTimer=setTimeout(gogo,200)}}gogo();return true},subscribeBars:function(symbolInfo,resolution,onRealtimeCallback,subscriberUID,onResetCacheNeededCallback){this._dep.sub('newData',function(data){if(data.constructor===Array){data=data[0]}onRealtimeCallback(data)})},unsubscribeBars:function(subscriberUID){},calculateHistoryDepth:function(resolution,resolutionBack,intervalBack){return undefined}};